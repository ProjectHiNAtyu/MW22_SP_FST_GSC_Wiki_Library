// IW9 GSC SOURCE
// Generated by https://github.com/xensik/gsc-tool

precache( offhand )
{
    setdvarifuninitialized( "dvar_425B104730459F47", 0 );
    scripts\sp\equipment\offhands::registeroffhandfirefunc( offhand, ::throwingknifefiremain );
}

throwingknifefiremain( grenade, weapon )
{
    if ( !isdefined( grenade ) )
        return;

    grenade.targetname = "offhand_throwingknife";

    if ( getdvarint( "dvar_425B104730459F47" ) == 1 )
        grenade scripts\engine\sp\utility::hudoutline_enable( "outline_depth_cyan" );

    grenade waittill( "missile_stuck", stuckto, _id_16A48D7056E5C472, _id_DDD80F5D1DA23C60, position, normal );

    if ( isdefined( stuckto ) && isai( stuckto ) )
    {
        if ( isdefined( _id_16A48D7056E5C472 ) )
            stuckto scripts\sp\utility::do_damage( 2000, position, level.player, grenade, "MOD_IMPACT", weapon.basename, _id_16A48D7056E5C472 );
        else
            stuckto scripts\sp\utility::do_damage( 2000, position, level.player, grenade, "MOD_IMPACT", weapon.basename );
    }

    grenade hide();
    _id_A2301015C1AB039E = grenade.origin;
    _id_A2301015C1AB039E = _id_A2301015C1AB039E + rotatevector( ( 2, 0, 0 ), grenade.angles );
    _id_9770EC8F19981834 = vectortoangles( -1 * normal );
    _id_A1093166DE09E6B8 = scripts\engine\utility::ter_op( weapon.basename == "throwingknife_kitchen", "Kitchen Throwing Knife", "Throwing Knife" );
    _id_840DA51FCF30FF7E = scripts\sp\loot::spawnlootitem( _id_A1093166DE09E6B8, _id_A2301015C1AB039E, _id_9770EC8F19981834, 0, 1, !isdefined( stuckto ), isdefined( stuckto ) );

    if ( isdefined( stuckto ) && !isai( stuckto ) )
        _id_840DA51FCF30FF7E linkto( stuckto );

    _id_840DA51FCF30FF7E thread _id_4158556B23018384( weapon );
    grenade delete();
}

_id_4158556B23018384( _id_626F13D105079101 )
{
    self endon( "delete" );
    self makeunusable();
    scripts\sp\player\cursor_hint::remove_cursor_hint();
    trigger = spawn( "trigger_radius", self.origin, 0, 64, 64 );
    trigger.targetname = "dropped_knife";
    trigger enablelinkto();
    trigger linkto( self );
    self.knife_trigger = trigger;
    _id_C48E47EDF7202570( _id_626F13D105079101 );
}

_id_C48E47EDF7202570( _id_626F13D105079101 )
{
    _id_A1093166DE09E6B8 = scripts\engine\utility::ter_op( _id_626F13D105079101.basename == "throwingknife_kitchen", "Kitchen Throwing Knife", "Throwing Knife" );

    for (;;)
    {
        self.knife_trigger waittill( "trigger", player );

        if ( !isdefined( player ) )
            break;

        if ( isplayer( player ) )
        {
            if ( scripts\sp\loot::_id_EDF54AA6C57ADB98( _id_A1093166DE09E6B8 ) < scripts\sp\loot::_id_57888D406854DC7F( _id_A1093166DE09E6B8 ) )
            {
                weaponname = scripts\sp\loot::getoffhandweaponname( _id_A1093166DE09E6B8 );

                if ( scripts\engine\sp\utility::player_has_equipment( weaponname ) )
                {
                    scripts\sp\loot::lootfuncandnotification( _id_A1093166DE09E6B8 );
                    _id_47048F2DD7D4D220();
                    player notify( "player_throwingKnifePickedUp" );
                    break;
                }
            }

            if ( level.script == "wounded" )
                player notify( "throwingknife_pickup_add_to_crafting_inventory", self );
        }
    }
}

_id_47048F2DD7D4D220()
{
    if ( isdefined( self.knife_trigger ) )
        self.knife_trigger delete();

    self delete();
}

_id_77F29D1ED8E5AD4C()
{
    for (;;)
        waitframe();
}

_id_73B30A27A6D8F81C()
{
    _id_375C5FF0A6F238AC = _func_9D30FD63965BAFA9( "bullet" );

    if ( isdefined( level.stealth ) )
        _id_375C5FF0A6F238AC = _func_61B03C8C194A6733( scripts\engine\utility::ter_op( scripts\engine\utility::flag( "stealth_spotted" ), "spotted", "hidden" ), "bullet" );

    _id_FBE5ADE21BD0D394 = _id_375C5FF0A6F238AC * _id_375C5FF0A6F238AC;
    self endon( "missile_stuck" );
    startpos = self.origin;
    endpos = startpos;
    _id_508D7F61241D178B = level.player getgunangles();
    _id_11C23BC7142B47F0 = 18;
    _id_ED80E26DC25B5432 = 60;
    _id_2F977E27FA739602 = ( _id_ED80E26DC25B5432 - _id_11C23BC7142B47F0 ) / 2;
    _id_E36F4333EB9FDAF4 = [];
    waitframe();

    while ( isdefined( self ) )
    {
        startpos = endpos;
        endpos = self.origin;
        _id_508D7F61241D178B = vectortoangles( endpos - startpos );
        _id_06DF2B5E4B03E9EA = vectortoangles( startpos - endpos );

        foreach ( guy in getaiarray( "axis", "team3" ) )
        {
            if ( scripts\engine\utility::array_contains( _id_E36F4333EB9FDAF4, guy ) )
                continue;

            max_z = guy.origin[2] + _id_ED80E26DC25B5432;

            for ( origin = guy.origin + ( 0, 0, _id_11C23BC7142B47F0 ); origin[2] <= max_z; origin = origin + ( 0, 0, _id_2F977E27FA739602 ) )
            {
                success = 0;

                if ( distancesquared( origin, endpos ) <= _id_FBE5ADE21BD0D394 )
                    success = 1;

                if ( !success )
                {
                    if ( !scripts\engine\utility::within_fov( startpos, _id_508D7F61241D178B, origin, 0 ) )
                        continue;

                    if ( !scripts\engine\utility::within_fov( endpos, _id_06DF2B5E4B03E9EA, origin, 0 ) )
                        continue;
                }

                if ( !success )
                {
                    _id_16290C9DDA466BCE = vectorfromlinetopoint( startpos, endpos, origin );
                    success = lengthsquared( _id_16290C9DDA466BCE ) <= _id_FBE5ADE21BD0D394;
                }

                if ( success )
                {
                    guy notify( "bulletwhizby", level.player, distance( endpos, origin ), endpos, endpos - startpos );

                    if ( isdefined( guy.stealth ) )
                        guy aieventlistenerevent( "bulletwhizby", level.player, endpos );

                    _id_E36F4333EB9FDAF4[_id_E36F4333EB9FDAF4.size] = guy;
                    break;
                }
            }
        }

        waitframe();
    }
}

_id_6566A2AF1F779902()
{
    _id_8BAB3203A26744B8 = getaiunittypearray( "bad_guys" );
    _id_EB5C16E9978852E3 = _func_9D30FD63965BAFA9( "silenced_shot_impact" );
    _id_A3B2BF368419BE73 = squared( _id_EB5C16E9978852E3 );

    foreach ( ai in _id_8BAB3203A26744B8 )
    {
        if ( !isalive( ai ) )
            continue;

        if ( distancesquared( ai.origin, self.origin ) > _id_A3B2BF368419BE73 )
            continue;

        if ( !ai hastacvis( self.origin ) )
            continue;

        ai aieventlistenerevent( "silenced_shot_impact", self, self.origin );
    }
}
