// IW9 GSC SOURCE
// Generated by https://github.com/xensik/gsc-tool

precache( offhand )
{
    precachemodel( "offhand_vm_cellphone_old" );
    level.g_effect["IED_explode"] = loadfx( "vfx/iw8/level/highway/ied_explosion" );
    scripts\sp\equipment\offhands::registeroffhandfirefunc( offhand, ::iedfiremain );
}

iedfiremain( _id_FE938103F6354AA9, weapon )
{
    if ( !isdefined( _id_FE938103F6354AA9 ) )
        return;

    _id_FE938103F6354AA9.targetname = "offhand_ied";

    if ( _id_FE938103F6354AA9.classname != "script_model" )
        _id_FE938103F6354AA9 waittill( "missile_stuck", stuckto );

    _id_FE938103F6354AA9 thread ieddetonationlogic( self, 25, 35 );
}

ieddetonationlogic( attacker, _id_A5D2DB5617EB9A05, _id_CCEA305D816855AA )
{
    self endon( "detonated" );
    self makeunusable();
    self.interact = iedcreatecursor( _id_A5D2DB5617EB9A05, _id_CCEA305D816855AA );
    self.interact waittill( "trigger" );
    origin = self.origin;
    self.interact delete();
    level.player notify( "triggeredIED", origin );

    if ( iedcanplaydetonategesture() )
        ieddetonategesture();

    thread ieddetonate( origin, attacker );
}

iedcanplaydetonategesture()
{
    if ( level.player playerads() == 1 )
        return 0;

    if ( level.player isreloading() )
        return 0;

    return 1;
}

ieddetonate( origin, attacker )
{
    level notify( "level_iedDetonated" );
    self notify( "detonated" );
    self delete();
    attacker notify( "detonatedIED", origin );
    iedplaydetonateeffects( origin );

    if ( distancesquared( level.player.origin, origin ) <= 10000 )
    {
        level.player shellshock( "default_nosound", 3.0 );
        level.player scripts\sp\utility::do_damage( 300, origin );
    }

    _id_FA48E1A11DFA38ED = 100;
    _id_99294D212B573D4A = _id_FA48E1A11DFA38ED * _id_FA48E1A11DFA38ED;
    _id_DA96C8943126A950 = getaiarray();

    foreach ( ai in _id_DA96C8943126A950 )
    {
        _id_4EB801042B324702 = distancesquared( origin, ai.origin );

        if ( _id_4EB801042B324702 > 360000 )
            continue;

        if ( _id_4EB801042B324702 > 160000 )
        {
            ai notify( "flashbang", ( 0, 0, 0 ), 1, 1, attacker, "allies" );
            continue;
        }

        if ( istrue( ai.magic_bullet_shield ) )
        {
            _id_FA1A63CD9F6ECCA2 = isplayer( attacker ) && scripts\engine\utility::is_equal( attacker.team, ai.team ) && _id_4EB801042B324702 <= _id_99294D212B573D4A;

            if ( _id_FA1A63CD9F6ECCA2 )
            {
                ai scripts\common\ai::stop_magic_bullet_shield();

                if ( isdefined( level.aigibfunction ) )
                    attacker [[ level.aigibfunction ]]( ai, ai geteye(), "MOD_RIFLE_BULLET" );

                scripts\sp\friendlyfire::missionfail( 0 );
                return;
            }
            else
            {
                ai notify( "flashbang", ( 0, 0, 0 ), 1, 1, attacker, "allies" );
                continue;
            }
        }

        if ( isdefined( level.aigibfunction ) && randomint( 100 ) < 100 )
        {
            attacker [[ level.aigibfunction ]]( ai, ai geteye(), "MOD_RIFLE_BULLET" );
            continue;
        }

        playfx( level.g_effect["vfx_gib_explode"], ai.origin );
        ai scripts\sp\utility::do_damage( ai.health + 9999, ai.origin, attacker, undefined, "MOD_EXPLOSIVE", "iw8_sh_oscar12" );
    }

    _id_DF8E0358F6E2B842 = distance( level.player.origin, origin );
    _id_5F3C8CFE71AC11E7 = _id_DF8E0358F6E2B842 / 13397;
    wait( _id_5F3C8CFE71AC11E7 );
    _id_751A55BF1BCE0CA9 = scripts\engine\math::normalize_value( 0, 15000, _id_DF8E0358F6E2B842 );
    intensity = scripts\engine\math::factor_value( 0.05, 0.32, _id_751A55BF1BCE0CA9 );
    earthquake( intensity, 1.2, origin, 15000 );
    playrumbleonposition( "damage_heavy", origin );
}

iedplaydetonateeffects( origin )
{
    if ( soundexists( "ied_activated" ) )
        level.player playsound( "ied_activated" );

    playfx( level.g_effect["IED_explode"], origin );
    physicsexplosionsphere( origin, 400, 200.0, 150 );

    if ( soundexists( "ied_expl_trans" ) )
        thread scripts\engine\utility::play_sound_in_space( "ied_expl_trans", origin );
}

ieddetonategesture()
{
    _id_D7CE16BA0556F168 = spawn( "script_model", level.player.origin );
    _id_D7CE16BA0556F168 setmodel( "offhand_vm_cellphone_old" );
    _id_D7CE16BA0556F168 notsolid();
    _id_D7CE16BA0556F168 _meth_A783F8C0603B0844( level.player, "tag_accessory_left", ( 0, 0, 0 ), ( 0, 0, 0 ), 1, "none" );
    _id_19F3850FCEDE775C = level.player getgestureanimlength( "ges_hod_phone_detonate" );
    _id_D7CE16BA0556F168 scripts\engine\utility::delaycall( _id_19F3850FCEDE775C, ::delete );
    level.player scripts\engine\sp\utility::player_gesture_force( "ges_hod_phone_detonate" );
    wait 0.5;
}

iedcreatecursor( _id_A5D2DB5617EB9A05, _id_CCEA305D816855AA )
{
    interact = scripts\engine\utility::spawn_tag_origin();
    interact.origin = interact.origin + ( 0, 0, 10 );
    interact linkto( self );
    interact scripts\sp\player\cursor_hint::create_cursor_hint( "tag_origin", ( 0, 0, 0 ), &"WEAPON/LABEL_DETONATE", _id_CCEA305D816855AA, 50000, 50000, 0, undefined, undefined, undefined, "duration_short", undefined, undefined, _id_A5D2DB5617EB9A05 );
    return interact;
}

iedcursorlogic( interact )
{
    self endon( "death" );
    interact endon( "death" );
    interact.cursor_hint_ent endon( "death" );
    self endon( "detonated" );

    for (;;)
    {
        if ( distancesquared( level.player.origin, self.origin ) <= 5625 )
            interact.cursor_hint_ent sethintstring( "^2Pickup" );
        else
            interact.cursor_hint_ent sethintstring( "^1Detonate" );

        waitframe();
    }
}
